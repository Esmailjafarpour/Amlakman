<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù¾Ù†Ù„ ÙÙˆÙ‚ Ù¾ÛŒØ´Ø±ÙØªÙ‡ Ø§Ù…Ù„Ø§Ú© Ù†Ø§Ø¯Ø±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@100;400;700;900&display=swap" rel="stylesheet">
    <script>tailwind.config = { darkMode: 'class' }</script>
    <style>
        body { font-family: 'Vazirmatn', sans-serif; transition: 0.3s; }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .error-shake { animation: shake 0.5s; border: 2px solid #ef4444 !important; }
        @keyframes shake { 0%, 100% {transform: translateX(0);} 25% {transform: translateX(-5px);} 75% {transform: translateX(5px);} }
        .glass { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(12px); }
        .dark .glass { background: rgba(15, 23, 42, 0.8); }
        .swiper-container { display: flex; overflow-x: auto; scrollbar-width: none; scroll-snap-type: x mandatory; }
        .swiper-slide { flex-shrink: 0; width: 100%; scroll-snap-align: start; height: 280px; }
        .nav-active { color: #2563eb !important; transform: scale(1.1); }
        .error-text {
    animation: fadeIn 0.3s ease;
}
.border-red-500 {
    border-color: #ef4444 !important;
    background-color: #fef2f2 !important; /* ÛŒÚ© Ù¾Ø³â€ŒØ²Ù…ÛŒÙ†Ù‡ Ø®ÛŒÙ„ÛŒ Ù…Ù„Ø§ÛŒÙ… Ù‚Ø±Ù…Ø² */
}
    </style>
</head>
<body class="pb-36 bg-slate-50 dark:bg-slate-950 text-slate-900 dark:text-slate-100 text-right">

    <div id="authPage" class="fixed inset-0 z-[600] bg-white dark:bg-slate-950 flex flex-col items-center justify-center p-8 overflow-y-auto">
        <h1 class="text-6xl font-black text-blue-600 mb-8 italic">NADER</h1>
        
        <div id="loginBox" class="w-full max-w-sm space-y-4 text-center">
            <input type="tel" id="authPhone" placeholder="Ø´Ù…Ø§Ø±Ù‡ Ù…ÙˆØ¨Ø§ÛŒÙ„" maxlength="11" class="w-full bg-slate-100 dark:bg-slate-900 py-5 px-6 rounded-3xl outline-none text-center text-xl font-bold border-2 border-transparent focus:border-blue-500">
            <button onclick="processAuth()" class="w-full bg-blue-600 text-white py-5 rounded-3xl font-black shadow-xl">ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ù¾Ù†Ù„</button>
            <button onclick="toggleAuthMode(true)" class="text-blue-600 font-bold text-sm mt-4">Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ù…Ø´Ø§ÙˆØ± Ø¬Ø¯ÛŒØ¯</button>
        </div>

        <div id="registerBox" class="hidden w-full max-w-sm space-y-4">
            <div class="text-center mb-4">
                <label class="cursor-pointer inline-block relative">
                    <img id="regAvatarPreview" src="https://cdn-icons-png.flaticon.com/512/3135/3135715.png" class="w-24 h-24 rounded-full border-4 border-blue-500 object-cover">
                    <input type="file" id="regAvatar" class="hidden" onchange="previewRegAvatar(this)">
                </label>
            </div>
            <input type="text" id="regName" placeholder="Ù†Ø§Ù…" class="w-full bg-slate-100 dark:bg-slate-900 p-4 rounded-2xl outline-none font-bold">
            <input type="text" id="regFamily" placeholder="Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ" class="w-full bg-slate-100 dark:bg-slate-900 p-4 rounded-2xl outline-none font-bold">
            <input type="tel" id="regPhone" placeholder="Ø´Ù…Ø§Ø±Ù‡ Ù…ÙˆØ¨Ø§ÛŒÙ„" maxlength="11" class="w-full bg-slate-100 dark:bg-slate-900 p-4 rounded-2xl outline-none font-bold text-center">
            <button onclick="handleRegister()" class="w-full bg-blue-600 text-white py-5 rounded-3xl font-black">Ø§Ø±Ø³Ø§Ù„ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¹Ø¶ÙˆÛŒØª</button>
            <button onclick="toggleAuthMode(false)" class="w-full text-slate-400 font-bold text-sm">Ø¨Ø§Ø²Ú¯Ø´Øª</button>
        </div>

        <div id="pendingBox" class="hidden text-center space-y-4">
            <div class="text-6xl">â³</div>
            <h2 class="font-black text-xl">Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± ØªØ§ÛŒÛŒØ¯ Ø§Ø¯Ù…ÛŒÙ†...</h2>
            <button onclick="location.reload()" class="text-blue-600 font-bold">ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ù¾Ù†Ù„</button>
        </div>
    </div>

    <div id="mainApp" class="hidden">
        <header class="p-5 glass sticky top-0 z-50 border-b dark:border-slate-800 flex justify-between items-center flex-row-reverse">
            <div class="flex items-center gap-2">
                <button onclick="toggleDarkMode()" class="p-2 rounded-xl bg-slate-100 dark:bg-slate-800">ğŸŒ™</button>
                <button onclick="handleLogout()" class="bg-red-500/10 text-red-500 p-2 rounded-xl text-xs font-bold">Ø®Ø±ÙˆØ¬</button>
            </div>
            <div class="flex items-center gap-3 flex-row-reverse">
                <div class="text-right">
                    <p id="userNameDisplay" class="text-xs font-black"></p>
                    <span id="adminBadge" class="hidden bg-blue-600 text-[8px] px-2 py-0.5 rounded-full text-white font-black uppercase">Admin</span>
                </div>
                <img id="headerAvatar" src="" class="w-12 h-12 rounded-full border-2 border-blue-500 object-cover shadow-lg">
            </div>
        </header>

        <main id="home" class="tab-content active px-5 py-8"><div id="propertyContainer" class="space-y-10"></div></main>
        
        <main id="dashboard" class="tab-content p-6">
            <h2 class="font-black text-lg mb-6 text-blue-600">Ú¯Ø²Ø§Ø±Ø´Ø§Øª Ùˆ Ù…Ø¯ÛŒØ±ÛŒØª</h2>
            <div id="adminTools" class="hidden space-y-6 mb-8">
                <div class="bg-orange-50 dark:bg-orange-900/10 p-4 rounded-3xl border border-orange-200">
                    <h3 class="text-xs font-black mb-3">ğŸ”” ØªØ§ÛŒÛŒØ¯ Ù…Ø´Ø§ÙˆØ±ÛŒÙ†</h3>
                    <div id="pendingList" class="space-y-2"></div>
                </div>
                <div id="activeConsultants" class="space-y-2"></div>
            </div>
            <div id="myVisitsLog" class="space-y-3"></div>
        </main>

        <main id="security" class="tab-content p-6">
            <h2 class="font-black text-lg mb-6">ğŸ”‘ ÙˆØ¶Ø¹ÛŒØª Ú©Ù„ÛŒØ¯Ù‡Ø§ÛŒ Ø®Ø§Ø±Ø¬ Ø´Ø¯Ù‡</h2>
            <div id="securityKeyList" class="space-y-4"></div>
        </main>

        <main id="calendar" class="tab-content p-6">
            <h2 class="font-black text-lg mb-6">ğŸ“… ØªÙ‚ÙˆÛŒÙ… Ù†Ø´Ø³Øªâ€ŒÙ‡Ø§ Ùˆ Ù‚Ø±Ø§Ø±Ù‡Ø§</h2>
            <button onclick="openCalendarModal()" class="w-full bg-blue-600 text-white p-4 rounded-2xl font-black mb-6">+ Ø«Ø¨Øª Ø¬Ù„Ø³Ù‡ Ø¬Ø¯ÛŒØ¯</button>
            <div id="calendarList" class="space-y-4"></div>
        </main>

        <div id="propModal" class="fixed inset-0 z-[700] hidden bg-black/80 backdrop-blur-md flex items-center justify-center p-6">
            <div class="bg-white dark:bg-slate-900 w-full max-w-sm rounded-[3rem] p-8 overflow-y-auto max-h-[90vh]">
            <h3 id="modalTitle" class="text-xl font-black mb-6 text-blue-600">Ø«Ø¨Øª Ù…Ù„Ú© Ø¬Ø¯ÛŒØ¯</h3>  
            <input type="hidden" id="editIndex" value="-1">             
            <div class="space-y-4">
                    <input type="file" id="pImages" multiple class="hidden" onchange="handleImageUpload(this)">
                    <label for="pImages" id="modalImgLabel" class="w-full h-20 border-2 border-dashed rounded-2xl flex items-center justify-center text-slate-400">ğŸ“¸ Ø¹Ú©Ø³â€ŒÙ‡Ø§</label>
                    <div id="previewGallery" class="flex gap-2 overflow-x-auto"></div>
                    <input type="text" id="pCode" placeholder="Ú©Ø¯ Ù…Ù„Ú©" class="w-full bg-slate-100 dark:bg-slate-800 p-4 rounded-2xl outline-none font-bold">
                    <input type="text" id="pTitle" placeholder="Ø¹Ù†ÙˆØ§Ù†" class="w-full bg-slate-100 dark:bg-slate-800 p-4 rounded-2xl outline-none font-bold">
                    <input type="text" id="pPrice" placeholder="Ù‚ÛŒÙ…Øª" class="w-full bg-slate-100 dark:bg-slate-800 p-4 rounded-2xl outline-none font-bold">
                      <div class="flex gap-2"> 
                         <button onclick="saveProperty()" class="w-full bg-blue-600 text-white py-4 rounded-2xl font-black">Ø°Ø®ÛŒØ±Ù‡</button>
                        <button onclick="closePropModal()" class="w-full text-slate-400">Ø§Ù†ØµØ±Ø§Ù</button>
                    </div>
                  
                </div>
            </div>
        </div>

        <div id="visitModal" class="fixed inset-0 z-[700] hidden bg-black/80 backdrop-blur-md flex items-center justify-center p-6">
            <div class="bg-white dark:bg-slate-900 w-full max-w-sm rounded-[3rem] p-8">
                <h3 class="font-black text-lg mb-4 text-center">Ø¬Ø²Ø¦ÛŒØ§Øª Ø®Ø±ÙˆØ¬ Ú©Ù„ÛŒØ¯</h3>
                <div class="space-y-4">
                    <select id="visitConsultantSelect" class="w-full bg-slate-100 dark:bg-slate-800 p-4 rounded-2xl font-bold"></select>
                    <input type="text" id="visitCustomerName" placeholder="Ù†Ø§Ù… Ù…Ø´ØªØ±ÛŒ" class="w-full bg-slate-100 dark:bg-slate-800 p-4 rounded-2xl font-bold">
                    <button onclick="confirmVisit()" class="w-full bg-blue-600 text-white py-4 rounded-2xl font-black">ØªØ§ÛŒÛŒØ¯</button>
                    <button onclick="closeVisitModal()" class="w-full text-slate-400">Ø§Ù†ØµØ±Ø§Ù</button>
                </div>
            </div>
        </div>

        <div id="calModal" class="fixed inset-0 z-[700] hidden bg-black/80 backdrop-blur-md flex items-center justify-center p-6">
            <div class="bg-white dark:bg-slate-900 w-full max-w-sm rounded-xl p-8">
                <h3 class="font-black text-lg mb-4">Ø«Ø¨Øª Ù‚Ø±Ø§Ø± Ø¬Ø¯ÛŒØ¯</h3>
                <div class="space-y-4">
                    <input type="text" id="calTitle" placeholder="Ù…ÙˆØ¶ÙˆØ¹ Ø¬Ù„Ø³Ù‡" class="w-full bg-slate-100 dark:bg-slate-800 p-4 rounded-2xl font-bold">
                    <input type="date" id="calDate" class="w-full bg-slate-100 dark:bg-slate-800 p-4 rounded-2xl font-bold">
                    <select id="calType" class="w-full bg-slate-100 dark:bg-slate-800 p-4 rounded-2xl font-bold">
                        <option value="Ù†Ø´Ø³Øª">ğŸ’ Ù†Ø´Ø³Øª Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯</option>
                        <option value="Ø¨Ø§Ø²Ø¯ÛŒØ¯">ğŸ  Ø¨Ø§Ø²Ø¯ÛŒØ¯ Ø­Ø¶ÙˆØ±ÛŒ</option>
                        <option value="Ú©Ø§Ø±Ø´Ù†Ø§Ø³ÛŒ">ğŸ“ Ú©Ø§Ø±Ø´Ù†Ø§Ø³ÛŒ Ù…Ù„Ú©</option>
                    </select>
                    <div class="flex gap-2">
                        <button onclick="saveCalendar()" class="w-full bg-blue-600 text-white py-4 rounded-2xl font-black">Ø«Ø¨Øª Ø¯Ø± ØªÙ‚ÙˆÛŒÙ…</button>
                        <button onclick="document.getElementById('calModal').classList.add('hidden')" class="w-full text-slate-400">Ø§Ù†ØµØ±Ø§Ù</button>
                    </div>
                </div>
            </div>
        </div>

        <nav class="fixed bottom-8 left-6 right-6 glass h-20 rounded-[2.5rem] flex justify-around items-center px-4 z-50 border shadow-2xl dark:border-slate-800">
            <button onclick="showTab('home', this)" class="nav-item nav-active flex flex-col items-center"><span class="text-xl">ğŸ </span><span class="text-[8px] font-black">ÙˆÛŒØªØ±ÛŒÙ†</span></button>
            <button onclick="showTab('dashboard', this)" class="nav-item text-slate-400 flex flex-col items-center"><span class="text-xl">ğŸ“Š</span><span class="text-[8px] font-black">ØªÛŒÙ…</span></button>
            <button onclick="handlePlusButtonClick()" class="bg-blue-600 text-white w-14 h-14 rounded-full flex items-center justify-center shadow-xl -mt-14 border-4 border-white dark:border-slate-950 text-2xl font-bold">+</button>
            <button onclick="showTab('security', this)" class="nav-item text-slate-400 flex flex-col items-center"><span class="text-xl">ğŸ”‘</span><span class="text-[8px] font-black">Ø§Ù…Ù†ÛŒØª</span></button>
            <button onclick="showTab('calendar', this)" class="nav-item text-slate-400 flex flex-col items-center"><span class="text-xl">ğŸ“…</span><span class="text-[8px] font-black">ØªÙ‚ÙˆÛŒÙ…</span></button>
        </nav>
    </div>

    <script>
        let properties = [], visits = {}, visitHistory = [], calendarEvents = [], currentImgList = [];
        let consultants = JSON.parse(localStorage.getItem('nader_v4_db')) || [{phone: "09337301641", name: "Ù†Ø§Ø¯Ø±", family: "Ù…Ø¯ÛŒØ±ÛŒØª", avatar: "https://cdn-icons-png.flaticon.com/512/3135/3135715.png", status: "active", isAdmin: true}];
        let currentUser = null, activeCode = null;

        // --- Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª ---
        function toggleAuthMode(isReg) { document.getElementById('loginBox').classList.toggle('hidden', isReg); document.getElementById('registerBox').classList.toggle('hidden', !isReg); }
        function previewRegAvatar(i) { const r = new FileReader(); r.onload=(e)=>document.getElementById('regAvatarPreview').src=e.target.result; r.readAsDataURL(i.files[0]); }
       function handleRegister() {
    // Ú¯Ø±ÙØªÙ† ÙÛŒÙ„Ø¯Ù‡Ø§
    const n = document.getElementById('regName');
    const f = document.getElementById('regFamily');
    const p = document.getElementById('regPhone');
    
    // Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ø§Ø±ÙˆØ±Ù‡Ø§ÛŒ Ù‚Ø¨Ù„ÛŒ
    clearErrors();

    let hasError = false;

    // 1. Ø§Ø¹ØªØ¨Ø§Ø± Ø³Ù†Ø¬ÛŒ Ù†Ø§Ù…
    if (n.value.trim().length < 2) {
        showError(n, "Ù†Ø§Ù… Ù†Ø¨Ø§ÛŒØ¯ Ú©Ù…ØªØ± Ø§Ø² Û² Ø­Ø±Ù Ø¨Ø§Ø´Ø¯");
        hasError = true;
    }

    // 2. Ø§Ø¹ØªØ¨Ø§Ø± Ø³Ù†Ø¬ÛŒ Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ
    if (f.value.trim().length < 2) {
        showError(f, "Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ Ø±Ø§ Ú©Ø§Ù…Ù„ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯");
        hasError = true;
    }

    // 3. Ø§Ø¹ØªØ¨Ø§Ø± Ø³Ù†Ø¬ÛŒ Ø³Ø®Øªâ€ŒÚ¯ÛŒØ±Ø§Ù†Ù‡ Ø´Ù…Ø§Ø±Ù‡ Ù…ÙˆØ¨Ø§ÛŒÙ„
    const phoneValue = p.value.trim();
    if (phoneValue.length === 0) {
        showError(p, "Ø´Ù…Ø§Ø±Ù‡ Ù…ÙˆØ¨Ø§ÛŒÙ„ Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª");
        hasError = true;
    } else if (!/^09[0-9]{9}$/.test(phoneValue)) {
        showError(p, "Ø´Ù…Ø§Ø±Ù‡ Ø¨Ø§ÛŒØ¯ Û±Û± Ø±Ù‚Ù… Ùˆ Ø¨Ø§ Û°Û¹ Ø´Ø±ÙˆØ¹ Ø´ÙˆØ¯");
        hasError = true;
    }

    // Ø§Ú¯Ø± Ø®Ø·Ø§ Ø¯Ø§Ø´ØªÛŒÙ…ØŒ Ù…ØªÙˆÙ‚Ù Ø´Ùˆ
    if (hasError) return;

    // --- Ø¯Ø± ØµÙˆØ±Øª Ù†Ø¨ÙˆØ¯ Ø®Ø·Ø§: Ø§Ø±Ø³Ø§Ù„ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¨Ù‡ Ù†Ø§Ø¯Ø± ---
    const newConsultant = {
        phone: phoneValue,
        name: n.value.trim(),
        family: f.value.trim(),
        avatar: document.getElementById('regAvatarPreview').src,
        status: "pending",
        isAdmin: false
    };

    consultants.push(newConsultant);
    saveDB();
    
    // Ù†Ù…Ø§ÛŒØ´ ØµÙØ­Ù‡ Ø§Ù†ØªØ¸Ø§Ø±
    document.getElementById('registerBox').classList.add('hidden');
    document.getElementById('pendingBox').classList.remove('hidden');
}

// ØªØ§Ø¨Ø¹ Ù†Ù…Ø§ÛŒØ´ Ø§Ø±ÙˆØ± Ø¨Ø§ Ù„Ø±Ø²Ø´ Ùˆ Ù…ØªÙ†
function showError(el, message) {
    el.classList.add('error-shake', 'border-red-500'); // Ù„Ø±Ø²Ø´ Ùˆ Ø±Ù†Ú¯ Ù‚Ø±Ù…Ø²
    
    // Ø³Ø§Ø®ØªÙ† ÛŒØ§ Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† ØªÚ¯ Ù…ØªÙ† Ø§Ø±ÙˆØ±
    let errorMsg = document.createElement('p');
    errorMsg.className = "error-text text-[10px] text-red-500 mt-1 mr-2 font-bold animate-fadeIn";
    errorMsg.innerText = "âš ï¸ " + message;
    
    // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ù…ØªÙ† Ø§Ø±ÙˆØ± Ø²ÛŒØ± ÙÛŒÙ„Ø¯
    el.parentNode.insertBefore(errorMsg, el.nextSibling);
    
    // Ø¨Ø¹Ø¯ Ø§Ø² Ûµ Ø«Ø§Ù†ÛŒÙ‡ Ù„Ø±Ø²Ø´ Ø±Ø§ Ø¨Ø±Ø¯Ø§Ø± Ø§Ù…Ø§ Ø±Ù†Ú¯ Ù‚Ø±Ù…Ø² Ø¨Ù…Ø§Ù†Ø¯ ØªØ§ Ø§ØµÙ„Ø§Ø­ Ø´ÙˆØ¯
    setTimeout(() => el.classList.remove('error-shake'), 500);
}

// ØªØ§Ø¨Ø¹ Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ Ø§Ø±ÙˆØ±Ù‡Ø§
function clearErrors() {
    document.querySelectorAll('.error-text').forEach(el => el.remove());
    document.querySelectorAll('input').forEach(el => el.classList.remove('border-red-500', 'error-shake'));
}
        function processAuth() {
            const p = document.getElementById('authPhone').value;
            const u = consultants.find(c=>c.phone===p);
            if(!u) return alert("ÛŒØ§ÙØª Ù†Ø´Ø¯.");
            if(u.status==="pending") return document.getElementById('loginBox').classList.add('hidden'), document.getElementById('pendingBox').classList.remove('hidden');
            currentUser=u; launchApp();
        }
        function launchApp() {
            document.getElementById('authPage').classList.add('hidden'); document.getElementById('mainApp').classList.remove('hidden');
            document.getElementById('headerAvatar').src=currentUser.avatar; document.getElementById('userNameDisplay').innerText=currentUser.name;
            if(currentUser.isAdmin) { document.getElementById('adminBadge').classList.remove('hidden'); document.getElementById('adminTools').classList.remove('hidden'); }
            updateUI();
        }

        // --- ØªÙˆØ§Ø¨Ø¹ Ø§ØµÙ„ÛŒ ---
function handlePlusButtonClick() { 
    if(!currentUser.isAdmin) return alert("ÙÙ‚Ø· Ø§Ø¯Ù…ÛŒÙ† Ø§Ø¬Ø§Ø²Ù‡ Ø¯Ø³ØªØ±Ø³ÛŒ Ø¯Ø§Ø±Ø¯."); 
    
    // Ø±ÛŒØ³Øª Ú©Ø±Ø¯Ù† Ù‡Ù…Ù‡ ÙÛŒÙ„Ø¯Ù‡Ø§ Ø¨Ø±Ø§ÛŒ Ø«Ø¨Øª Ø¬Ø¯ÛŒØ¯
    window.editingIndex = -1; 
    document.getElementById('modalTitle').innerText = "Ø«Ø¨Øª Ù…Ù„Ú© Ø¬Ø¯ÛŒØ¯";
    document.getElementById('pCode').value = '';
    document.getElementById('pTitle').value = '';
    document.getElementById('pPrice').value = '';
    currentImgList = []; 
    document.getElementById('previewGallery').innerHTML = ''; 
    
    document.getElementById('propModal').classList.remove('hidden'); 
}        function handleImageUpload(i) { Array.from(i.files).forEach(f=>{const r=new FileReader(); r.onload=(e)=>{currentImgList.push(e.target.result); renderPreview();}; r.readAsDataURL(f);}); }
        function renderPreview() { document.getElementById('previewGallery').innerHTML=currentImgList.map(s=>`<img src="${s}" class="w-12 h-12 rounded object-cover">`).join(''); }
       function saveProperty() {
    const c = document.getElementById('pCode');
    const t = document.getElementById('pTitle');
    const imgLabel = document.getElementById('modalImgLabel');
    
    // Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ø§Ø±ÙˆØ±Ù‡Ø§ÛŒ Ù‚Ø¨Ù„ÛŒ
    document.querySelectorAll('.error-text-prop').forEach(e => e.remove());
    let hasError = false;

    // Ø§Ø¹ØªØ¨Ø§Ø± Ø³Ù†Ø¬ÛŒ Ø¹Ú©Ø³
    if (currentImgList.length === 0) {
        showPropError(imgLabel, "Ø­Ø¯Ø§Ù‚Ù„ ÛŒÚ© Ø¹Ú©Ø³ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯");
        hasError = true;
    }
    // Ø§Ø¹ØªØ¨Ø§Ø± Ø³Ù†Ø¬ÛŒ Ú©Ø¯ Ùˆ Ø¹Ù†ÙˆØ§Ù†
    if (!c.value.trim()) { showPropError(c, "Ú©Ø¯ Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª"); hasError = true; }
    if (!t.value.trim()) { showPropError(t, "Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª"); hasError = true; }

    if (hasError) return;

    const propData = {
        code: c.value,
        title: t.value,
        price: document.getElementById('pPrice').value || "ØªÙˆØ§ÙÙ‚ÛŒ",
        imgs: [...currentImgList]
    };

    // Ú†Ú© Ú©Ø±Ø¯Ù† Ø§ÛŒÙ†Ú©Ù‡ Ø¢ÛŒØ§ Ø¯Ø± Ø­Ø§Ù„Øª ÙˆÛŒØ±Ø§ÛŒØ´ Ù‡Ø³ØªÛŒÙ… ÛŒØ§ Ø«Ø¨Øª Ø¬Ø¯ÛŒØ¯
    if (window.editingIndex !== undefined && window.editingIndex !== -1) {
        properties[window.editingIndex] = propData;
        window.editingIndex = -1; // Ø±ÛŒØ³Øª Ú©Ø±Ø¯Ù† Ø¨Ø¹Ø¯ Ø§Ø² ÙˆÛŒØ±Ø§ÛŒØ´
    } else {
        properties.unshift(propData); // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø¨Ù‡ Ø§ÙˆÙ„ Ù„ÛŒØ³Øª
    }

    // Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± Ù…Ø±ÙˆØ±Ú¯Ø±
    localStorage.setItem('nader_props', JSON.stringify(properties));
    
    closePropModal();
    updateUI();
}

        // ØªØ§Ø¨Ø¹ Ú©Ù…Ú©ÛŒ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ø§Ø±ÙˆØ± Ø¯Ø± Ù…ÙˆØ¯Ø§Ù„ Ù…Ù„Ú©
        function showPropError(el, msg) {
            el.classList.add('error-shake', 'border-red-500');
            const err = document.createElement('div');
            err.className = 'error-text-prop text-[10px] text-red-500 font-bold mt-1';
            err.innerText = 'âš ï¸ ' + msg;
            el.parentNode.insertBefore(err, el.nextSibling);
            setTimeout(() => el.classList.remove('error-shake'), 500);
        }

        function handleKeyAction(code) {
            if(visits[code]) { if(confirm("Ø¨Ø§Ø²Ú¯Ø´Øª Ú©Ù„ÛŒØ¯ØŸ")) { delete visits[code]; updateUI(); } }
            else { activeCode=code; document.getElementById('visitConsultantSelect').innerHTML=consultants.filter(c=>c.status==="active").map(c=>`<option>${c.name} ${c.family}</option>`).join(''); document.getElementById('visitModal').classList.remove('hidden'); }
        }
        function confirmVisit() {
            const cust=document.getElementById('visitCustomerName'); if(!cust.value) return triggerError(cust);
            const data = {code:activeCode, consultant:document.getElementById('visitConsultantSelect').value, customer:cust.value, time:new Date().toLocaleTimeString('fa-IR')};
            visits[activeCode]=data; visitHistory.unshift(data); closeVisitModal(); updateUI();
        }

        // --- ØªÙ‚ÙˆÛŒÙ… ---
        function openCalendarModal() { document.getElementById('calModal').classList.remove('hidden'); }
        function saveCalendar() {
            const t=document.getElementById('calTitle'), d=document.getElementById('calDate'), type=document.getElementById('calType');
            if(!t.value || !d.value) return triggerError(t), triggerError(d);
            calendarEvents.unshift({title:t.value, date:d.value, type:type.value, creator:currentUser.name});
            document.getElementById('calModal').classList.add('hidden'); updateUI();
        }

        // --- Ø¢Ù¾Ø¯ÛŒØª Ø±Ø§Ø¨Ø· Ú©Ø§Ø±Ø¨Ø±ÛŒ ---
        function updateUI() {
            // ÙˆÛŒØªØ±ÛŒÙ†
           document.getElementById('propertyContainer').innerHTML = properties.map((p, idx)=>`
    <div class="bg-white dark:bg-slate-900 rounded-[2.5rem] overflow-hidden shadow-lg border dark:border-slate-800 relative">
        ${currentUser.isAdmin ? `
            <button onclick="prepareEdit(${idx})" class="absolute top-4 left-4 z-20 bg-white/90 dark:bg-slate-800/90 p-2 rounded-full shadow-lg border border-blue-500">âœï¸</button>
        ` : ''}

        <div class="relative group">
            <div id="slider-${idx}" onscroll="updateDots(${idx})" class="swiper-container flex overflow-x-auto snap-x snap-mandatory scroll-smooth shadow-inner">
                ${p.imgs.map(img=>`<div class="swiper-slide min-w-full snap-start h-72"><img src="${img}" class="w-full h-full object-cover"></div>`).join('')}
            </div>
            
            <div class="absolute bottom-4 left-0 right-0 flex justify-center gap-1.5 z-10">
                ${p.imgs.map((_, i) => `<div id="dot-${idx}-${i}" class="w-2 h-2 rounded-full bg-white/40 transition-all ${i===0?'bg-white w-4':''}"></div>`).join('')}
            </div>
        </div>

        <div class="p-6">
            <div class="flex justify-between items-center mb-4 text-right">
                <h3 class="font-black text-lg">${p.title}</h3>
                <span class="text-blue-600 font-bold">${p.price}</span>
            </div>
            <button onclick="handleKeyAction('${p.code}')" class="w-full ${visits[p.code]?'bg-orange-500':'bg-slate-900 dark:bg-blue-600'} text-white py-4 rounded-2xl font-black text-xs">
                ${visits[p.code]?'âš ï¸ Ø¯Ø³Øª: '+visits[p.code].consultant : 'ğŸ”“ Ø®Ø±ÙˆØ¬ Ú©Ù„ÛŒØ¯ ÙˆØ§Ø­Ø¯ '+p.code}
            </button>
        </div>
    </div>`).join('');

            // Ø§Ù…Ù†ÛŒØª Ú©Ù„ÛŒØ¯Ù‡Ø§
            document.getElementById('securityKeyList').innerHTML = Object.values(visits).map(v=>`
                <div class="bg-orange-50 dark:bg-orange-900/20 p-4 rounded-2xl border-r-4 border-orange-500 flex justify-between">
                    <div><p class="font-black text-xs">ÙˆØ§Ø­Ø¯ ${v.code}</p><p class="text-[10px] opacity-60">ØªÙˆØ³Ø·: ${v.consultant} | Ø¨Ø±Ø§ÛŒ: ${v.customer}</p></div>
                    <button onclick="handleKeyAction('${v.code}')" class="text-[10px] bg-white dark:bg-slate-800 px-3 py-1 rounded-lg shadow-sm">ØªØ§ÛŒÛŒØ¯ Ø¨Ø±Ú¯Ø´Øª</button>
                </div>`).join('') || '<p class="opacity-30 text-center">ØªÙ…Ø§Ù… Ú©Ù„ÛŒØ¯Ù‡Ø§ Ø¯Ø± Ø¨Ù†Ú¯Ø§Ù‡ Ù…ÙˆØ¬ÙˆØ¯ Ø§Ø³Øª.</p>';

            // ØªÙ‚ÙˆÛŒÙ…
            document.getElementById('calendarList').innerHTML = calendarEvents.map(e=>`
                <div class="bg-white dark:bg-slate-800 p-4 rounded-2xl border-r-4 border-blue-500 shadow-sm">
                    <div class="flex justify-between items-start">
                        <div><p class="font-black text-sm">${e.title}</p><p class="text-[10px] opacity-50">${e.date} | Ø«Ø¨Øª ØªÙˆØ³Ø·: ${e.creator}</p></div>
                        <span class="text-[10px] bg-blue-100 dark:bg-blue-900 text-blue-600 px-2 py-1 rounded-full font-bold">${e.type}</span>
                    </div>
                </div>`).join('') || '<p class="opacity-30 text-center">Ø±ÙˆÛŒØ¯Ø§Ø¯ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡.</p>';

            // Ù…Ø¯ÛŒØ±ÛŒØª Ø§Ø¯Ù…ÛŒÙ†
            if(currentUser.isAdmin) {
                const pend = consultants.filter(c=>c.status==="pending");
                document.getElementById('pendingList').innerHTML = pend.map(c=>`
                    <div class="flex justify-between items-center bg-white p-2 rounded-xl">
                        <span class="text-xs font-bold">${c.name}</span>
                        <button onclick="approveConsultant('${c.phone}')" class="bg-green-600 text-white text-[8px] px-2 py-1 rounded-lg">ØªØ§ÛŒÛŒØ¯</button>
                    </div>`).join('');
            }
        }

        function approveConsultant(p) { const i=consultants.findIndex(c=>c.phone===p); consultants[i].status="active"; saveDB(); updateUI(); }
        function saveDB() { localStorage.setItem('nader_v4_db', JSON.stringify(consultants)); }
        function triggerError(el) { el.classList.add('error-shake'); setTimeout(()=>el.classList.remove('error-shake'),500); }
        function closePropModal() { document.getElementById('propModal').classList.add('hidden'); }
        function closeVisitModal() { document.getElementById('visitModal').classList.add('hidden'); }
        function toggleDarkMode() { document.documentElement.classList.toggle('dark'); }
        function handleLogout() { location.reload(); }
        function showTab(id, btn) {
            document.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('nav-active'));
            btn.classList.add('nav-active');
        }

        function prepareEdit(index) {
    const p = properties[index];
    
    // ØªØºÛŒÛŒØ± Ø¹Ù†ÙˆØ§Ù† Ù…ÙˆØ¯Ø§Ù„ Ø¨Ù‡ ÙˆÛŒØ±Ø§ÛŒØ´
    document.getElementById('modalTitle').innerText = "ÙˆÛŒØ±Ø§ÛŒØ´ Ù…Ù„Ú© " + p.code;
    
    // Ù¾Ø± Ú©Ø±Ø¯Ù† ÙÛŒÙ„Ø¯Ù‡Ø§ Ø¨Ø§ Ø§Ø·Ù„Ø§Ø¹Ø§Øª ÙØ¹Ù„ÛŒ
    document.getElementById('pCode').value = p.code;
    document.getElementById('pTitle').value = p.title;
    document.getElementById('pPrice').value = p.price;
    
    // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¹Ú©Ø³â€ŒÙ‡Ø§ÛŒ Ù‚Ø¨Ù„ÛŒ
    currentImgList = [...p.imgs];
    renderPreview(); // ØªØ§Ø¨Ø¹ÛŒ Ú©Ù‡ Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´ Ø¹Ú©Ø³â€ŒÙ‡Ø§ Ø±Ø§ Ù…ÛŒâ€ŒØ³Ø§Ø²Ø¯
    
    // Ø°Ø®ÛŒØ±Ù‡ Ø§ÛŒÙ†Ø¯Ú©Ø³ Ø¯Ø± ÛŒÚ© Ù…ØªØºÛŒØ± Ø³Ø±Ø§Ø³Ø±ÛŒ ÛŒØ§ ÙÛŒÙ„Ø¯ Ù…Ø®ÙÛŒ Ø¨Ø±Ø§ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø¯Ø± Ø²Ù…Ø§Ù† Ø°Ø®ÛŒØ±Ù‡
    window.editingIndex = index;
    
    // Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† Ù…ÙˆØ¯Ø§Ù„
    document.getElementById('propModal').classList.remove('hidden');
}

function updateDots(propIdx) {
    const slider = document.getElementById(`slider-${propIdx}`);
    const scrollLeft = Math.abs(slider.scrollLeft); // Ù…Ù‚Ø¯Ø§Ø± Ø§Ø³Ú©Ø±ÙˆÙ„ Ø´Ø¯Ù‡
    const width = slider.offsetWidth; // Ø¹Ø±Ø¶ Ù‡Ø± Ø¹Ú©Ø³
    const activeIndex = Math.round(scrollLeft / width); // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø§ÛŒÙ†Ú©Ù‡ Ú©Ø¯Ø§Ù… Ø¹Ú©Ø³ Ø±ÙˆØ¨Ø±ÙˆØ³Øª

    // Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† ØªÙ…Ø§Ù… Ù†Ù‚Ø·Ù‡â€ŒÙ‡Ø§ÛŒ Ù…Ø±Ø¨ÙˆØ· Ø¨Ù‡ Ø§ÛŒÙ† Ù…Ù„Ú© Ùˆ Ø¢Ù¾Ø¯ÛŒØª Ú©Ø±Ø¯Ù†Ø´Ø§Ù†
    const dots = document.querySelectorAll(`[id^="dot-${propIdx}-"]`);
    dots.forEach((dot, i) => {
        if (i === activeIndex) {
            dot.classList.add('bg-white', 'w-4'); // Ù†Ù‚Ø·Ù‡ ÙØ¹Ø§Ù„: Ø³ÙÛŒØ¯ Ùˆ Ú©Ø´ÛŒØ¯Ù‡
            dot.classList.remove('bg-white/40');
        } else {
            dot.classList.remove('bg-white', 'w-4'); // Ù†Ù‚Ø·Ù‡ ØºÛŒØ±ÙØ¹Ø§Ù„: Ú©Ø¯Ø± Ùˆ Ú©ÙˆÚ†Ú©
            dot.classList.add('bg-white/40');
        }
    });
}
    </script>
</body>
</html>